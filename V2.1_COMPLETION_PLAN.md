# v2.1 Virtual MIDI Output - Completion Plan

**Date**: 2025-01-17
**Status**: 60% Complete (SendMIDI done, port creation pending)
**Estimated Time**: ~1 week (5-7 days)

---

## Current Status

### ✅ Already Complete (Delivered Early in v2.2)

**SendMIDI Action Type** (AMI-168 - Done):
- 6 MIDI message types (NoteOn, NoteOff, CC, ProgramChange, PitchBend, Aftertouch)
- Proper MIDI encoding (status bytes, data byte masking, channel support)
- GUI integration (SendMidiActionEditor.svelte, 707 lines)
- Test coverage (6 tests passing)
- Works with existing virtual MIDI ports (IAC Driver, loopMIDI, ALSA)

### ⏳ Remaining Work

**1. Virtual MIDI Port Creation** (AMI-167):
- Platform-specific API implementation
- Port naming and lifecycle management
- Auto-reconnection on device changes

**2. DAW Documentation** (~4 files):
- Comprehensive DAW control guide
- DAW-specific example profiles
- MIDI output troubleshooting

**3. Integration Testing**:
- Test with major DAWs
- Performance validation
- Compatibility matrix

---

## Remaining Tasks Breakdown

### Task 1: Implement Virtual MIDI Port Creation (AMI-167)
**Estimated Time**: 3-4 days
**Priority**: High
**Issue**: https://linear.app/amiable-dev/issue/AMI-167/implement-virtual-midi-port-creation

#### Subtasks

**Day 1: macOS Implementation**
- [ ] Research CoreMIDI virtual port API
- [ ] Implement `create_virtual_port()` for macOS
  ```rust
  // midimon-core/src/midi_output.rs
  pub fn create_virtual_port(name: &str) -> Result<VirtualMidiPort> {
      #[cfg(target_os = "macos")]
      {
          // Use CoreMIDI MIDISourceCreate or MIDIDestinationCreate
          // Handle port lifecycle
      }
  }
  ```
- [ ] Test with Logic Pro and Ableton Live
- [ ] Verify IAC Driver integration (ensure no conflicts)

**Day 2: Linux Implementation**
- [ ] Research ALSA virtual port API
- [ ] Implement `create_virtual_port()` for Linux
  ```rust
  #[cfg(target_os = "linux")]
  {
      // Use alsa-rs for virtual port creation
      // snd_seq_create_simple_port() wrapper
  }
  ```
- [ ] Test with ALSA utilities
- [ ] Verify JACK MIDI compatibility (if applicable)

**Day 3: Windows Implementation**
- [ ] Research Windows MIDI API (WinMM or rtpMIDI)
- [ ] Implement `create_virtual_port()` for Windows
  ```rust
  #[cfg(target_os = "windows")]
  {
      // Use winapi::um::mmeapi for MIDI output
      // Consider rtpMIDI for network MIDI
  }
  ```
- [ ] Test with Windows DAWs
- [ ] Handle driver installation requirements

**Day 4: Port Lifecycle & Config**
- [ ] Add port naming configuration
  ```toml
  [midi_output]
  enabled = true
  port_name = "MIDIMon Virtual Output"
  auto_create = true
  ```
- [ ] Implement port lifecycle management:
  - Create on daemon startup (if `auto_create = true`)
  - Destroy on daemon shutdown
  - Handle reconnection on device changes
- [ ] Add `midimonctl` commands:
  - `midimonctl midi-output status` - Show port status
  - `midimonctl midi-output create <name>` - Manually create port
  - `midimonctl midi-output destroy` - Destroy port
- [ ] Write unit tests for port creation/destruction
- [ ] Write integration tests with loopback testing

---

### Task 2: Write DAW Documentation
**Estimated Time**: 2 days
**Priority**: Medium
**Dependencies**: Task 1 complete (need working virtual ports for screenshots)

#### Subtasks

**Day 1: Core Documentation**
- [ ] **docs-site/src/guides/daw-control.md** (~500 lines)
  - Introduction to DAW control with MIDIMon
  - Virtual MIDI port setup per platform
  - Basic transport control examples
  - CC parameter mapping examples
  - Troubleshooting section

- [ ] **docs-site/src/troubleshooting/midi-output.md** (~300 lines)
  - Common MIDI output issues
  - Platform-specific troubleshooting
  - DAW-specific issues
  - Latency debugging
  - Port visibility problems

**Day 2: DAW-Specific Examples**
- [ ] **docs-site/src/examples/logic-pro.md** (~400 lines)
  - Logic Pro MIDI setup
  - Transport control profile
  - Mixer CC mapping
  - Smart Controls integration
  - Screenshot walkthrough

- [ ] **docs-site/src/examples/ableton-live.md** (~400 lines)
  - Ableton Live MIDI setup
  - Clip launcher control
  - Device parameter mapping
  - Session view integration
  - Screenshot walkthrough

- [ ] Update **docs-site/src/SUMMARY.md**
  - Add new guides to navigation
  - Add new examples section
  - Proper ordering

- [ ] Verify `mdbook build` passes

---

### Task 3: Integration Testing & Validation
**Estimated Time**: 1-2 days
**Priority**: High
**Dependencies**: Tasks 1 & 2 complete

#### Subtasks

**DAW Testing Matrix**:
- [ ] **Logic Pro** (macOS)
  - Transport control (Play, Stop, Record)
  - Volume faders (CC 7)
  - Pan controls (CC 10)
  - MIDI Learn compatibility

- [ ] **Ableton Live** (macOS/Windows)
  - Clip triggering
  - Device parameter control
  - Transport control
  - Scene triggering

- [ ] **Reaper** (Cross-platform)
  - Custom control surface setup
  - Transport control
  - Track arming
  - FX parameter mapping

- [ ] **FL Studio** (Windows - if accessible)
  - Pattern triggering
  - Mixer controls
  - Transport

**Performance Testing**:
- [ ] MIDI output latency (<5ms target)
- [ ] Sustained operation (8-hour stress test)
- [ ] Memory usage (no leaks over time)
- [ ] CPU usage during high-throughput scenarios

**Compatibility Matrix**:
- [ ] Document tested DAW versions
- [ ] Note any DAW-specific quirks
- [ ] Create compatibility table for README

---

## Technical Implementation Details

### Platform-Specific APIs

**macOS (CoreMIDI)**:
```rust
// Use coremidi crate or direct CoreFoundation bindings
use coremidi::{Client, Source, Destination};

pub struct MacOSVirtualPort {
    client: Client,
    source: Source,  // For sending MIDI out
}

impl MacOSVirtualPort {
    pub fn new(name: &str) -> Result<Self> {
        let client = Client::new(name)?;
        let source = client.source(name)?;
        Ok(Self { client, source })
    }

    pub fn send(&self, message: &[u8]) -> Result<()> {
        // Send MIDI message
    }
}
```

**Linux (ALSA)**:
```rust
// Use alsa crate
use alsa::seq::{Seq, PortCap, PortType};

pub struct ALSAVirtualPort {
    seq: Seq,
    port: i32,
}

impl ALSAVirtualPort {
    pub fn new(name: &str) -> Result<Self> {
        let seq = Seq::open(None, None, false)?;
        let port = seq.create_simple_port(
            name,
            PortCap::READ | PortCap::SUBS_READ,
            PortType::MIDI_GENERIC | PortType::APPLICATION,
        )?;
        Ok(Self { seq, port })
    }
}
```

**Windows (WinMM)**:
```rust
// Use winapi crate
use winapi::um::mmeapi::{midiOutOpen, midiOutShortMsg};

pub struct WindowsVirtualPort {
    handle: HMIDIOUT,
}

// Note: Windows doesn't have true virtual MIDI ports in WinMM
// May need to use loopMIDI or rtpMIDI as external solution
```

### Configuration Format

```toml
# config.toml
[midi_output]
enabled = true
port_name = "MIDIMon Virtual Output"
auto_create = true  # Create on daemon startup
channel = 0         # Default MIDI channel

# Example mapping using SendMIDI
[[modes.mappings]]
[modes.mappings.trigger]
type = "Note"
note = 1

[modes.mappings.action]
type = "SendMIDI"
port = "MIDIMon Virtual Output"  # Or "IAC Driver Bus 1"
message = { type = "NoteOn", note = 60, velocity = 100, channel = 0 }
```

---

## Dependencies & Crates

**New Crate Dependencies** (add to `midimon-core/Cargo.toml`):

```toml
[target.'cfg(target_os = "macos")'.dependencies]
coremidi = "0.9"  # For macOS virtual ports

[target.'cfg(target_os = "linux")'.dependencies]
alsa = "0.9"  # For Linux ALSA virtual ports

[target.'cfg(target_os = "windows")'.dependencies]
winapi = { version = "0.3", features = ["mmeapi"] }  # For Windows MIDI
```

---

## Testing Strategy

### Unit Tests
```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_create_virtual_port() {
        let port = create_virtual_port("Test Port").unwrap();
        assert!(port.is_active());
    }

    #[test]
    fn test_send_note_on() {
        let port = create_virtual_port("Test Port").unwrap();
        port.send_note_on(60, 100, 0).unwrap();
    }

    #[test]
    fn test_port_lifecycle() {
        let port = create_virtual_port("Test Port").unwrap();
        drop(port);  // Ensure cleanup
        // Verify port no longer visible
    }
}
```

### Integration Tests
```rust
#[test]
fn test_midi_loopback() {
    // Create virtual output port
    let output = create_virtual_port("MIDIMon Out").unwrap();

    // Connect MIDI input to same port (loopback)
    let input = open_midi_input("MIDIMon Out").unwrap();

    // Send message and verify received
    output.send_note_on(60, 100, 0).unwrap();
    let msg = input.receive_timeout(Duration::from_millis(100)).unwrap();
    assert_eq!(msg, [0x90, 60, 100]);
}
```

---

## Documentation Examples

### Example: Logic Pro Transport Control

```toml
# Logic Pro transport control using MIDIMon
[[modes]]
name = "Logic Pro"
color = "purple"

# Play/Pause
[[modes.mappings]]
[modes.mappings.trigger]
type = "Note"
note = 1

[modes.mappings.action]
type = "Conditional"
[[modes.mappings.action.conditions]]
type = "AppFrontmost"
bundle_id = "com.apple.logic10"
then_action = { type = "SendMIDI", port = "MIDIMon Virtual Output", message = { type = "CC", controller = 115, value = 127, channel = 0 } }

# Stop
[[modes.mappings]]
[modes.mappings.trigger]
type = "Note"
note = 2

[modes.mappings.action]
type = "SendMIDI"
port = "MIDIMon Virtual Output"
message = { type = "CC", controller = 116, value = 127, channel = 0 }

# Record
[[modes.mappings]]
[modes.mappings.trigger]
type = "Note"
note = 3

[modes.mappings.action]
type = "SendMIDI"
port = "MIDIMon Virtual Output"
message = { type = "CC", controller = 117, value = 127, channel = 0 }
```

---

## Acceptance Criteria

v2.1 is complete when:

- [ ] Virtual MIDI ports can be created on macOS, Linux, and Windows
- [ ] Ports appear in system MIDI device lists (Audio MIDI Setup, aconnect, etc.)
- [ ] SendMIDI action works with both virtual and physical ports
- [ ] Port lifecycle managed properly (create, destroy, reconnect)
- [ ] DAW documentation complete (4 files, ~1,600 lines total)
- [ ] Integration tests passing for major DAWs
- [ ] Performance validated (latency <5ms, no memory leaks)
- [ ] `mdbook build` passes with no errors
- [ ] All tests passing (existing 145 + new virtual port tests)
- [ ] AMI-167 marked "Done" in Linear
- [ ] v2.1.0 release tagged

---

## Timeline

**Week 1**:
- Day 1: macOS virtual port implementation
- Day 2: Linux virtual port implementation
- Day 3: Windows virtual port implementation
- Day 4: Port lifecycle & config integration
- Day 5: Core documentation (daw-control.md, midi-output.md)

**Week 2** (if needed):
- Day 6: DAW-specific examples (Logic Pro, Ableton Live)
- Day 7: Integration testing & validation
- Release: Tag v2.1.0

**Optimistic**: 5 days
**Realistic**: 7 days

---

## Next Steps After v2.1

Once v2.1 is complete:
1. ✅ Tag v2.1.0 release
2. ✅ Update Linear (mark AMI-167 Done, update AMI-109)
3. ✅ Update CHANGELOG.md
4. Plan v2.3: Plugin Architecture (AMI-192-195)
   - ~4-6 weeks of work
   - Enables community extensibility
   - HTTP, Spotify, HomeKit example plugins

---

**Author**: Claude Code
**Created**: 2025-01-17
**Target Completion**: 2025-01-24 (1 week)

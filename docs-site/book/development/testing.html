<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Testing Guide - MIDIMon Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Transform MIDI controllers into advanced macro pads with RGB feedback and timing-based triggers">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">MIDIMon Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/amiable-dev/midimon" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/amiable-dev/midimon/edit/main/docs-site/src/src/development/testing.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="testing-guide"><a class="header" href="#testing-guide">Testing Guide</a></h1>
<p>This guide covers testing strategies for MIDIMon, including hardware-independent testing using the MIDI device simulator.</p>
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h2>
<ul>
<li><a href="#midi-device-simulator">MIDI Device Simulator</a></li>
<li><a href="#running-tests">Running Tests</a></li>
<li><a href="#end-to-end-test-suite">End-to-End Test Suite</a></li>
<li><a href="#code-coverage">Code Coverage</a></li>
<li><a href="#test-reporting">Test Reporting</a></li>
<li><a href="#writing-tests">Writing Tests</a></li>
<li><a href="#interactive-cli-tool">Interactive CLI Tool</a></li>
<li><a href="#test-scenarios">Test Scenarios</a></li>
</ul>
<h2 id="midi-device-simulator"><a class="header" href="#midi-device-simulator">MIDI Device Simulator</a></h2>
<p>The MIDI device simulator allows comprehensive testing of MIDIMon without requiring physical hardware. It simulates all MIDI events and complex user interactions with precise timing control.</p>
<h3 id="features"><a class="header" href="#features">Features</a></h3>
<p>The simulator supports:</p>
<ul>
<li><strong>Basic MIDI Events</strong>: Note On/Off, Control Change, Aftertouch, Pitch Bend, Program Change</li>
<li><strong>Velocity Levels</strong>: Soft (0-40), Medium (41-80), Hard (81-127)</li>
<li><strong>Timing-Based Triggers</strong>: Long press, double-tap detection</li>
<li><strong>Complex Gestures</strong>: Chords, encoder rotation, velocity ramps</li>
<li><strong>Precise Timing</strong>: Configurable delays and durations</li>
<li><strong>Event Capture</strong>: Inspect all generated MIDI messages</li>
</ul>
<h3 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h3>
<pre><code class="language-rust">use midi_simulator::{MidiSimulator, Gesture, EncoderDirection};

// Create a simulator on MIDI channel 0
let sim = MidiSimulator::new(0);

// Simulate a simple note press
sim.note_on(60, 100);
sim.note_off(60);

// Get captured events
let events = sim.get_events();
assert_eq!(events.len(), 2); // Note on + Note off</code></pre>
<h2 id="running-tests"><a class="header" href="#running-tests">Running Tests</a></h2>
<h3 id="unit-tests"><a class="header" href="#unit-tests">Unit Tests</a></h3>
<p>Run the simulator's built-in unit tests:</p>
<pre><code class="language-bash">cargo test --test midi_simulator
</code></pre>
<p>Expected output:</p>
<pre><code>running 12 tests
test tests::test_note_on_off ... ok
test tests::test_velocity_levels ... ok
test tests::test_control_change ... ok
test tests::test_aftertouch ... ok
test tests::test_pitch_bend ... ok
test tests::test_program_change ... ok
test tests::test_simple_tap_gesture ... ok
test tests::test_chord_gesture ... ok
test tests::test_encoder_simulation ... ok
test tests::test_velocity_ramp_gesture ... ok
test tests::test_scenario_builder ... ok
test tests::test_channel_masking ... ok

test result: ok. 12 passed; 0 failed
</code></pre>
<h3 id="integration-tests"><a class="header" href="#integration-tests">Integration Tests</a></h3>
<p>Run integration tests that verify the complete event processing pipeline:</p>
<pre><code class="language-bash">cargo test --test integration_tests
</code></pre>
<p>These tests cover:</p>
<ul>
<li>Basic note event handling</li>
<li>Velocity level detection</li>
<li>Long press simulation with timing validation</li>
<li>Double-tap detection</li>
<li>Chord detection with multiple notes</li>
<li>Encoder direction detection (CW/CCW)</li>
<li>Aftertouch and pitch bend</li>
<li>Complex multi-event scenarios</li>
</ul>
<h3 id="all-tests"><a class="header" href="#all-tests">All Tests</a></h3>
<p>Run all tests including unit and integration:</p>
<pre><code class="language-bash">cargo test
</code></pre>
<h3 id="using-nextest-recommended"><a class="header" href="#using-nextest-recommended">Using Nextest (Recommended)</a></h3>
<p>For improved test output and parallel execution, use cargo-nextest:</p>
<pre><code class="language-bash"># Install nextest
cargo install cargo-nextest

# Run tests with nextest
cargo nextest run --all-features

# Or use the convenience script
./scripts/test-nextest.sh
</code></pre>
<p>Nextest provides:</p>
<ul>
<li>Faster test execution through parallelization</li>
<li>Better output formatting with progress indicators</li>
<li>More detailed failure reporting</li>
<li>Per-test timing information</li>
</ul>
<h2 id="end-to-end-test-suite"><a class="header" href="#end-to-end-test-suite">End-to-End Test Suite</a></h2>
<p>The E2E test suite (<code>tests/e2e_tests.rs</code>) provides comprehensive validation of the complete MIDIMon pipeline from MIDI input through event processing, mapping, and action execution. See <a href="#integration-test-suites">Integration Test Suites</a> section below for full documentation of all E2E workflows, test architecture, and writing E2E tests.</p>
<h3 id="quick-start-1"><a class="header" href="#quick-start-1">Quick Start</a></h3>
<pre><code class="language-bash"># Run all E2E tests (20+ workflow tests)
cargo test --test e2e_tests

# Expected: 37 tests passed covering all critical workflows
</code></pre>
<h2 id="code-coverage"><a class="header" href="#code-coverage">Code Coverage</a></h2>
<p>MIDIMon uses <code>cargo-llvm-cov</code> for code coverage tracking. The project maintains a minimum coverage threshold of 0.35% (baseline) with a Phase 1 target of 85%.</p>
<h3 id="installing-coverage-tools"><a class="header" href="#installing-coverage-tools">Installing Coverage Tools</a></h3>
<pre><code class="language-bash"># Install cargo-llvm-cov
cargo install cargo-llvm-cov
</code></pre>
<h3 id="generating-coverage-reports"><a class="header" href="#generating-coverage-reports">Generating Coverage Reports</a></h3>
<h4 id="terminal-summary-default"><a class="header" href="#terminal-summary-default">Terminal Summary (Default)</a></h4>
<p>Generate a coverage summary in the terminal:</p>
<pre><code class="language-bash"># Using cargo-llvm-cov directly
cargo llvm-cov --all-features --workspace

# Or use the convenience script
./scripts/coverage.sh

# Or use just command
just coverage
</code></pre>
<p>Output example:</p>
<pre><code>Filename                      Regions    Missed Regions     Cover   Functions  Missed Functions  Executed       Lines      Missed Lines     Cover
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
actions.rs                        212               212     0.00%          12                12     0.00%         134               134     0.00%
config.rs                          52                42    19.23%           3                 2    33.33%          52                47     9.62%
main.rs                           278               278     0.00%          13                13     0.00%         151               151     0.00%
mappings.rs                        96                96     0.00%           8                 8     0.00%          71                71     0.00%
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
TOTAL                            2263              2253     0.44%          66                65     1.52%        1413              1408     0.35%
</code></pre>
<h4 id="html-report"><a class="header" href="#html-report">HTML Report</a></h4>
<p>Generate an interactive HTML coverage report:</p>
<pre><code class="language-bash"># Generate HTML report
./scripts/coverage.sh --html

# Or use just command
just coverage-html

# Report saved to: target/llvm-cov/html/index.html
</code></pre>
<h4 id="html-report-with-auto-open"><a class="header" href="#html-report-with-auto-open">HTML Report with Auto-Open</a></h4>
<p>Generate and automatically open the coverage report in your browser:</p>
<pre><code class="language-bash"># Generate and open HTML report
./scripts/coverage.sh --open

# Or use just command
just coverage-open
</code></pre>
<h4 id="lcov-format-for-ci"><a class="header" href="#lcov-format-for-ci">LCOV Format (for CI)</a></h4>
<p>Generate coverage in LCOV format for Codecov or other CI tools:</p>
<pre><code class="language-bash"># Generate lcov.info
./scripts/coverage.sh --lcov

# Or use just command
just coverage-lcov

# Output: lcov.info
</code></pre>
<h3 id="coverage-configuration"><a class="header" href="#coverage-configuration">Coverage Configuration</a></h3>
<p>Coverage settings are configured in <code>.llvm-cov.toml</code>:</p>
<pre><code class="language-toml">[report]
# Fail if coverage is below this percentage
fail-under-lines = 0.35

[filter]
# Exclude test files and binaries from coverage
exclude-filename-regex = [
    ".*/tests/.*",
    ".*/bin/.*"
]
</code></pre>
<h3 id="coverage-targets"><a class="header" href="#coverage-targets">Coverage Targets</a></h3>
<ul>
<li><strong>Phase 0 Baseline</strong>: 0.35% (established)</li>
<li><strong>Phase 1 Target</strong>: 85% line coverage</li>
<li><strong>Minimum Threshold</strong>: 80% (enforced in CI)</li>
</ul>
<h3 id="coverage-in-cicd"><a class="header" href="#coverage-in-cicd">Coverage in CI/CD</a></h3>
<p>Coverage is automatically tracked on every pull request:</p>
<ol>
<li><strong>GitHub Actions</strong> runs coverage on all PRs</li>
<li><strong>Codecov</strong> receives coverage reports and provides:
<ul>
<li>Coverage percentage badge</li>
<li>Line-by-line coverage visualization</li>
<li>Coverage diffs on PRs</li>
<li>Historical coverage trends</li>
</ul>
</li>
<li><strong>PR Comments</strong> show coverage delta (increase/decrease)</li>
<li><strong>Status Checks</strong> fail if coverage drops below threshold</li>
</ol>
<p>View current coverage: <a href="https://codecov.io/gh/amiable-dev/midimon"><img src="https://codecov.io/gh/amiable-dev/midimon/branch/main/graph/badge.svg" alt="codecov" /></a></p>
<h3 id="local-coverage-workflow"><a class="header" href="#local-coverage-workflow">Local Coverage Workflow</a></h3>
<p>Recommended workflow for maintaining coverage:</p>
<pre><code class="language-bash"># 1. Write tests for new code
vim tests/my_feature_test.rs

# 2. Run tests to verify they pass
cargo nextest run

# 3. Generate coverage report
just coverage-open

# 4. Identify uncovered lines (shown in red in HTML report)

# 5. Add tests for uncovered code paths

# 6. Verify coverage improved
just coverage
</code></pre>
<h2 id="test-reporting"><a class="header" href="#test-reporting">Test Reporting</a></h2>
<h3 id="github-actions-integration"><a class="header" href="#github-actions-integration">GitHub Actions Integration</a></h3>
<p>All tests run automatically on:</p>
<ul>
<li><strong>Push to main/develop branches</strong></li>
<li><strong>Pull requests</strong></li>
<li><strong>Manual workflow dispatch</strong></li>
</ul>
<p>Test results are displayed in the GitHub Actions UI with:</p>
<ul>
<li>Test count (passed/failed/skipped)</li>
<li>Execution time</li>
<li>Detailed failure logs</li>
<li>Coverage percentage</li>
</ul>
<h3 id="nextest-reports"><a class="header" href="#nextest-reports">Nextest Reports</a></h3>
<p>Nextest provides enhanced test reporting:</p>
<pre><code class="language-bash"># Run with detailed output
cargo nextest run --verbose

# Generate JUnit XML report
cargo nextest run --junit junit.xml

# Show only failed tests
cargo nextest run --failure-output immediate
</code></pre>
<h3 id="coverage-reports-in-prs"><a class="header" href="#coverage-reports-in-prs">Coverage Reports in PRs</a></h3>
<p>When you create a pull request, Codecov automatically:</p>
<ol>
<li>Analyzes coverage for changed files</li>
<li>Posts a comment with coverage diff</li>
<li>Updates status checks</li>
<li>Shows coverage on changed lines</li>
</ol>
<p>Example PR comment:</p>
<pre><code>Coverage: 85.2% (+2.1%) vs main

Files changed coverage:
  - src/new_feature.rs: 92.3% ✓
  - src/existing.rs: 78.1% ⚠️ (below target)
</code></pre>
<h3 id="local-test-scripts"><a class="header" href="#local-test-scripts">Local Test Scripts</a></h3>
<p>Use convenience scripts for common testing tasks:</p>
<pre><code class="language-bash"># Run all tests
./scripts/test.sh

# Run with nextest
./scripts/test-nextest.sh

# Generate coverage
./scripts/coverage.sh [--html|--open|--lcov]
</code></pre>
<h3 id="just-commands"><a class="header" href="#just-commands">Just Commands</a></h3>
<p>The <code>justfile</code> provides convenient shortcuts:</p>
<pre><code class="language-bash"># View all available commands
just

# Run tests
just test              # Standard cargo test
just test-nextest      # With nextest
just test-watch        # Watch mode (requires cargo-watch)

# Coverage
just coverage          # Terminal summary
just coverage-html     # HTML report
just coverage-open     # HTML report + open in browser
just coverage-lcov     # LCOV format for CI

# Linting and formatting
just lint              # Run clippy
just fmt               # Format code
just fmt-check         # Check formatting

# Complete CI check locally
just ci                # Run all CI checks (fmt, lint, test, coverage)
</code></pre>
<h2 id="writing-tests"><a class="header" href="#writing-tests">Writing Tests</a></h2>
<h3 id="basic-event-tests"><a class="header" href="#basic-event-tests">Basic Event Tests</a></h3>
<p>Test simple MIDI event generation:</p>
<pre><code class="language-rust">#[test]
fn test_my_feature() {
    let sim = MidiSimulator::new(0);

    // Simulate user action
    sim.note_on(60, 100);
    sim.note_off(60);

    // Verify events
    let events = sim.get_events();
    assert_eq!(events.len(), 2);
    assert_eq!(events[0], vec![0x90, 60, 100]); // Note On
    assert_eq!(events[1], vec![0x80, 60, 0x40]); // Note Off
}</code></pre>
<h3 id="velocity-level-tests"><a class="header" href="#velocity-level-tests">Velocity Level Tests</a></h3>
<p>Test velocity-sensitive actions:</p>
<pre><code class="language-rust">#[test]
fn test_velocity_levels() {
    let sim = MidiSimulator::new(0);

    // Test soft, medium, hard presses
    sim.note_on(60, 30);   // Soft (0-40)
    sim.note_on(60, 70);   // Medium (41-80)
    sim.note_on(60, 110);  // Hard (81-127)

    let events = sim.get_events();
    assert_eq!(events.len(), 3);
}</code></pre>
<h3 id="timing-based-tests"><a class="header" href="#timing-based-tests">Timing-Based Tests</a></h3>
<p>Test long press and timing detection:</p>
<pre><code class="language-rust">#[test]
fn test_long_press() {
    let sim = MidiSimulator::new(0);
    let start = Instant::now();

    sim.perform_gesture(Gesture::LongPress {
        note: 60,
        velocity: 80,
        hold_ms: 2500,
    });

    let duration = start.elapsed();
    assert!(duration &gt;= Duration::from_millis(2500));
}</code></pre>
<h3 id="double-tap-tests"><a class="header" href="#double-tap-tests">Double-Tap Tests</a></h3>
<p>Test double-tap detection with gap timing:</p>
<pre><code class="language-rust">#[test]
fn test_double_tap() {
    let sim = MidiSimulator::new(0);

    sim.perform_gesture(Gesture::DoubleTap {
        note: 60,
        velocity: 80,
        tap_duration_ms: 50,
        gap_ms: 200,
    });

    let events = sim.get_events();
    assert_eq!(events.len(), 4); // 2 note ons + 2 note offs
}</code></pre>
<h3 id="chord-tests"><a class="header" href="#chord-tests">Chord Tests</a></h3>
<p>Test chord detection with multiple simultaneous notes:</p>
<pre><code class="language-rust">#[test]
fn test_chord() {
    let sim = MidiSimulator::new(0);

    sim.perform_gesture(Gesture::Chord {
        notes: vec![60, 64, 67], // C major chord
        velocity: 80,
        stagger_ms: 10,
        hold_ms: 500,
    });

    let events = sim.get_events();
    assert_eq!(events.len(), 6); // 3 note ons + 3 note offs
}</code></pre>
<h3 id="encoder-tests"><a class="header" href="#encoder-tests">Encoder Tests</a></h3>
<p>Test encoder rotation with direction detection:</p>
<pre><code class="language-rust">#[test]
fn test_encoder() {
    let sim = MidiSimulator::new(0);

    sim.perform_gesture(Gesture::EncoderTurn {
        cc: 1,
        direction: EncoderDirection::Clockwise,
        steps: 5,
        step_delay_ms: 0,
    });

    let events = sim.get_events();
    assert_eq!(events.len(), 5);

    // Verify values are increasing
    for i in 1..events.len() {
        assert!(events[i][2] &gt; events[i-1][2]);
    }
}</code></pre>
<h3 id="scenario-builder"><a class="header" href="#scenario-builder">Scenario Builder</a></h3>
<p>Create complex test scenarios with the builder pattern:</p>
<pre><code class="language-rust">use midi_simulator::ScenarioBuilder;

#[test]
fn test_complex_scenario() {
    let sim = MidiSimulator::new(0);

    let scenario = ScenarioBuilder::new()
        .note_on(60, 100)
        .wait(100)
        .control_change(1, 64)
        .wait(100)
        .aftertouch(80)
        .wait(100)
        .note_off(60)
        .build();

    sim.execute_sequence(scenario);

    let events = sim.get_events();
    assert_eq!(events.len(), 4);
}</code></pre>
<h2 id="interactive-cli-tool"><a class="header" href="#interactive-cli-tool">Interactive CLI Tool</a></h2>
<p>The simulator includes an interactive command-line interface for manual testing and experimentation.</p>
<h3 id="starting-the-cli"><a class="header" href="#starting-the-cli">Starting the CLI</a></h3>
<pre><code class="language-bash">cargo run --bin midi_simulator
</code></pre>
<h3 id="available-commands"><a class="header" href="#available-commands">Available Commands</a></h3>
<pre><code>╭─────────────────────────────────────────────────────────────╮
│ COMMANDS                                                    │
├─────────────────────────────────────────────────────────────┤
│ Basic:                                                      │
│   help, h, ?              Show help message                 │
│   quit, exit, q           Exit the simulator                │
│   clear, c                Clear event queue                 │
│   events, e               Show captured events              │
├─────────────────────────────────────────────────────────────┤
│ MIDI Events:                                                │
│   note &lt;num&gt; &lt;vel&gt;        Send note on/off                  │
│   velocity &lt;note&gt;         Test velocity levels              │
│   long &lt;note&gt; [ms]        Simulate long press               │
│   double &lt;note&gt; [gap_ms]  Simulate double-tap               │
│   chord &lt;n1&gt; &lt;n2&gt; ...     Simulate chord                    │
│   encoder &lt;cc&gt; &lt;cw|ccw&gt;   Simulate encoder rotation         │
│   aftertouch &lt;pressure&gt;   Send aftertouch                   │
│   pitch &lt;value&gt;           Send pitch bend (0-16383)         │
│   cc &lt;num&gt; &lt;val&gt;          Send control change               │
├─────────────────────────────────────────────────────────────┤
│ Scenarios:                                                  │
│   demo                    Run full demonstration            │
│   scenario [name]         Run specific test scenario        │
╰─────────────────────────────────────────────────────────────╯
</code></pre>
<h3 id="example-session"><a class="header" href="#example-session">Example Session</a></h3>
<pre><code class="language-bash"># Start the CLI
cargo run --bin midi_simulator

# Test velocity levels
&gt; velocity 60
Simulating velocity levels (soft, medium, hard)...
✓ Velocity test complete

# Test long press
&gt; long 60 2500
Simulating long press for 2500ms...
✓ Long press complete

# Test double-tap
&gt; double 60 200
Simulating double-tap with 200ms gap...
✓ Double-tap complete

# Test chord (C major)
&gt; chord 60 64 67
Simulating chord: [60, 64, 67]
✓ Chord complete

# Test encoder rotation
&gt; encoder 1 cw 5
Simulating encoder CC1 Clockwise 5 steps...
✓ Encoder simulation complete

# Show captured events
&gt; events
Captured events:
  1: [90, 60, 64, ...]
  2: [80, 60, 40, ...]
  ...

# Run full demo
&gt; demo
Running demonstration scenarios...
1. Testing velocity levels...
2. Testing long press...
3. Testing double-tap...
4. Testing chord...
5. Testing encoder...
✓ Demo complete

# Exit
&gt; quit
Goodbye!
</code></pre>
<h2 id="test-scenarios"><a class="header" href="#test-scenarios">Test Scenarios</a></h2>
<p>The simulator includes pre-built test scenarios for common testing needs.</p>
<h3 id="velocity-scenario"><a class="header" href="#velocity-scenario">Velocity Scenario</a></h3>
<p>Tests all three velocity levels:</p>
<pre><code class="language-bash">&gt; scenario velocity
Testing velocity levels: Soft (30), Medium (70), Hard (110)
✓ Velocity scenario complete
</code></pre>
<h3 id="timing-scenario"><a class="header" href="#timing-scenario">Timing Scenario</a></h3>
<p>Tests short, medium, and long press durations:</p>
<pre><code class="language-bash">&gt; scenario timing
Testing press durations: Short (100ms), Medium (500ms), Long (2500ms)
✓ Timing scenario complete
</code></pre>
<h3 id="double-tap-scenario"><a class="header" href="#double-tap-scenario">Double-Tap Scenario</a></h3>
<p>Tests double-tap detection:</p>
<pre><code class="language-bash">&gt; scenario doubletap
Testing double-tap with 200ms gap
✓ Double-tap scenario complete
</code></pre>
<h3 id="chord-scenario"><a class="header" href="#chord-scenario">Chord Scenario</a></h3>
<p>Tests chord detection with C major:</p>
<pre><code class="language-bash">&gt; scenario chord
Testing chord detection: C major (60, 64, 67)
✓ Chord scenario complete
</code></pre>
<h3 id="encoder-scenario"><a class="header" href="#encoder-scenario">Encoder Scenario</a></h3>
<p>Tests encoder rotation in both directions:</p>
<pre><code class="language-bash">&gt; scenario encoder
Testing encoder: 5 steps CW, then 5 steps CCW
✓ Encoder scenario complete
</code></pre>
<h3 id="complex-scenario"><a class="header" href="#complex-scenario">Complex Scenario</a></h3>
<p>Tests mixed events and complex interactions:</p>
<pre><code class="language-bash">&gt; scenario complex
Running complex scenario: mixed events...
✓ Complex scenario complete
</code></pre>
<h2 id="advanced-gestures"><a class="header" href="#advanced-gestures">Advanced Gestures</a></h2>
<h3 id="velocity-ramp"><a class="header" href="#velocity-ramp">Velocity Ramp</a></h3>
<p>Simulate a velocity ramp from soft to hard:</p>
<pre><code class="language-rust">sim.perform_gesture(Gesture::VelocityRamp {
    note: 60,
    min_velocity: 20,
    max_velocity: 120,
    steps: 5,
});</code></pre>
<h3 id="simple-tap"><a class="header" href="#simple-tap">Simple Tap</a></h3>
<p>Simulate a quick tap with precise duration:</p>
<pre><code class="language-rust">sim.perform_gesture(Gesture::SimpleTap {
    note: 60,
    velocity: 80,
    duration_ms: 100,
});</code></pre>
<h2 id="event-inspection"><a class="header" href="#event-inspection">Event Inspection</a></h2>
<h3 id="getting-events"><a class="header" href="#getting-events">Getting Events</a></h3>
<pre><code class="language-rust">// Get all events and clear the queue
let events = sim.get_events();

// Peek at last event without clearing
let last = sim.peek_last_event();

// Clear the queue
sim.clear_events();</code></pre>
<h3 id="parsing-events"><a class="header" href="#parsing-events">Parsing Events</a></h3>
<pre><code class="language-rust">for event in events {
    let status = event[0];
    let message_type = status &amp; 0xF0;
    let channel = status &amp; 0x0F;

    match message_type {
        0x90 =&gt; println!("Note On: {} vel {}", event[1], event[2]),
        0x80 =&gt; println!("Note Off: {}", event[1]),
        0xB0 =&gt; println!("CC{}: {}", event[1], event[2]),
        0xD0 =&gt; println!("Aftertouch: {}", event[1]),
        0xE0 =&gt; println!("Pitch Bend: {} {}", event[1], event[2]),
        _ =&gt; println!("Unknown message type"),
    }
}</code></pre>
<h2 id="debug-output"><a class="header" href="#debug-output">Debug Output</a></h2>
<p>Enable debug output to see all MIDI messages:</p>
<pre><code class="language-rust">let mut sim = MidiSimulator::new(0);
sim.set_debug(true);

sim.note_on(60, 100);
// Output: [SIM] Sending: [90, 3C, 64]</code></pre>
<h2 id="best-practices"><a class="header" href="#best-practices">Best Practices</a></h2>
<ol>
<li><strong>Clear events between tests</strong>: Always clear the event queue between tests to avoid interference</li>
<li><strong>Use gestures for complex interactions</strong>: Prefer high-level gestures over manual event sequences</li>
<li><strong>Verify timing</strong>: Use <code>Instant::now()</code> to verify timing-sensitive operations</li>
<li><strong>Test edge cases</strong>: Test velocity boundaries (0, 40, 41, 80, 81, 127)</li>
<li><strong>Test multiple channels</strong>: Verify channel masking works correctly</li>
<li><strong>Use scenario builder</strong>: Build complex scenarios declaratively with the builder pattern</li>
</ol>
<h2 id="continuous-integration"><a class="header" href="#continuous-integration">Continuous Integration</a></h2>
<p>The simulator is designed to work in CI environments without hardware:</p>
<pre><code class="language-yaml"># .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: Run tests
        run: cargo test --all-features
</code></pre>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<h3 id="tests-timeout"><a class="header" href="#tests-timeout">Tests Timeout</a></h3>
<p>If timing-based tests timeout, increase tolerance:</p>
<pre><code class="language-rust">assert!(duration &gt;= Duration::from_millis(2500));
assert!(duration &lt; Duration::from_millis(2700)); // 200ms tolerance</code></pre>
<h3 id="event-count-mismatch"><a class="header" href="#event-count-mismatch">Event Count Mismatch</a></h3>
<p>Remember that <code>get_events()</code> clears the queue:</p>
<pre><code class="language-rust">let events1 = sim.get_events(); // Gets and clears
let events2 = sim.get_events(); // Empty, events were already consumed</code></pre>
<h3 id="velocity-detection"><a class="header" href="#velocity-detection">Velocity Detection</a></h3>
<p>Ensure velocities match expected ranges:</p>
<pre><code class="language-rust">// Soft: 0-40
// Medium: 41-80
// Hard: 81-127</code></pre>
<h2 id="integration-test-suites"><a class="header" href="#integration-test-suites">Integration Test Suites</a></h2>
<p>MIDIMon includes comprehensive integration test suites that verify complete feature sets without requiring physical hardware.</p>
<h3 id="event-processing-tests-ami-117"><a class="header" href="#event-processing-tests-ami-117">Event Processing Tests (AMI-117)</a></h3>
<p>Location: <code>tests/event_processing_tests.rs</code></p>
<p>Tests for aftertouch and pitch bend event processing:</p>
<p><strong>Aftertouch Tests (26 tests)</strong>:</p>
<ul>
<li>Full pressure range validation (0-127)</li>
<li>Continuous pressure variation</li>
<li>Boundary value testing (min/max)</li>
<li>Aftertouch with note press scenarios</li>
<li>Multi-channel aftertouch support</li>
</ul>
<p><strong>Pitch Bend Tests (26 tests)</strong>:</p>
<ul>
<li>Center position verification (8192)</li>
<li>Full 14-bit range testing (0-16383)</li>
<li>Positive and negative bend ranges</li>
<li>Smooth sweep simulations</li>
<li>Pitch bend with note combinations</li>
<li>Multi-channel pitch bend support</li>
</ul>
<pre><code class="language-bash"># Run event processing tests
cargo test --test event_processing_tests
</code></pre>
<h3 id="action-tests-ami-118"><a class="header" href="#action-tests-ami-118">Action Tests (AMI-118)</a></h3>
<p>Location: <code>tests/action_tests.rs</code></p>
<p>Tests for application launch and volume control actions:</p>
<p><strong>Launch Application Tests (14 tests)</strong>:</p>
<ul>
<li>Valid application path handling</li>
<li>Invalid path error handling</li>
<li>Paths with spaces</li>
<li>Process spawning verification</li>
<li>Permission denied scenarios</li>
<li>Concurrent process spawning</li>
<li>Platform-specific behavior detection</li>
</ul>
<p><strong>Volume Control Tests (14 tests)</strong>:</p>
<ul>
<li>Command detection (macOS, Linux, Windows)</li>
<li>Volume up/down command structure</li>
<li>Mute toggle command structure</li>
<li>Volume set command structure</li>
<li>Mock volume control execution</li>
<li>Shell command escaping</li>
</ul>
<pre><code class="language-bash"># Run action tests
cargo test --test action_tests
</code></pre>
<h3 id="action-orchestration-tests-ami-119"><a class="header" href="#action-orchestration-tests-ami-119">Action Orchestration Tests (AMI-119)</a></h3>
<p>Location: <code>tests/action_orchestration_tests.rs</code></p>
<p>Tests for complex action orchestration (38 tests):</p>
<p><strong>Sequence Actions (F16)</strong>:</p>
<ul>
<li>Action ordering verification</li>
<li>Empty sequence handling</li>
<li>Single action sequences</li>
<li>Sequences with delays</li>
<li>Error propagation in sequences</li>
</ul>
<p><strong>Delay Actions (F17)</strong>:</p>
<ul>
<li>Timing accuracy (50ms, 100ms, 500ms)</li>
<li>Zero delay handling</li>
<li>Multiple sequential delays</li>
<li>Timing precision validation (±10ms tolerance)</li>
</ul>
<p><strong>MouseClick Actions (F18)</strong>:</p>
<ul>
<li>Click simulation structure</li>
<li>Coordinate validation</li>
<li>Button type validation (left, right, middle)</li>
<li>Click sequences with delays</li>
</ul>
<p><strong>Repeat Actions (F19)</strong>:</p>
<ul>
<li>Repeat count verification</li>
<li>Repeat with delays</li>
<li>Zero and single repetitions</li>
<li>High-volume repeat handling (100+ iterations)</li>
</ul>
<p><strong>Conditional Actions (F20)</strong>:</p>
<ul>
<li>Application-based conditions</li>
<li>Time-based conditions (hour ranges)</li>
<li>Modifier key conditions</li>
<li>Mode-based conditions</li>
<li>Multiple condition combinations (AND/OR logic)</li>
<li>Complex conditional expressions</li>
</ul>
<pre><code class="language-bash"># Run action orchestration tests
cargo test --test action_orchestration_tests
</code></pre>
<h3 id="end-to-end-tests-ami-120"><a class="header" href="#end-to-end-tests-ami-120">End-to-End Tests (AMI-120)</a></h3>
<p>Location: <code>tests/e2e_tests.rs</code></p>
<p>Comprehensive E2E testing of the complete MIDIMon pipeline (MIDI Input → Event Processing → Mapping → Action Execution):</p>
<p><strong>Critical Workflows (20 tests)</strong>:</p>
<ul>
<li>Simple pad press → keystroke</li>
<li>Velocity-sensitive mapping (soft/medium/hard)</li>
<li>Long press detection (≥1000ms threshold)</li>
<li>Double-tap recognition (&lt;300ms window)</li>
<li>Chord detection (&lt;50ms window)</li>
<li>Mode switching via encoder</li>
<li>Mode-specific vs global mappings</li>
<li>Action sequences with delays</li>
<li>Conditional actions (app/time/mode)</li>
<li>Volume control via encoder</li>
</ul>
<p><strong>Performance &amp; Edge Cases (5 tests)</strong>:</p>
<ul>
<li>Timing latency verification (&lt;1ms)</li>
<li>Rapid note events (20+ events)</li>
<li>Invalid note range handling (0, 1, 126, 127)</li>
<li>Throughput testing (200 events &lt;10ms)</li>
<li>Memory stability (1000 events)</li>
</ul>
<pre><code class="language-bash"># Run all E2E tests
cargo test --test e2e_tests

# Expected: 37 tests passed
</code></pre>
<h3 id="test-coverage-summary"><a class="header" href="#test-coverage-summary">Test Coverage Summary</a></h3>
<p>Total test count: <strong>183 tests</strong></p>
<p>Breakdown by suite:</p>
<ul>
<li><code>integration_tests.rs</code>: 29 tests (basic event processing)</li>
<li><code>event_processing_tests.rs</code>: 26 tests (aftertouch &amp; pitch bend)</li>
<li><code>action_tests.rs</code>: 14 tests (launch &amp; volume control)</li>
<li><code>action_orchestration_tests.rs</code>: 38 tests (sequences &amp; conditionals)</li>
<li><code>e2e_tests.rs</code>: 37 tests (end-to-end critical workflows) ← <strong>NEW</strong></li>
<li><code>config_compatibility_test.rs</code>: 15 tests (config validation)</li>
<li><code>midi_simulator.rs</code>: 12 tests (simulator validation)</li>
<li>Additional unit tests: 12 tests (various modules)</li>
</ul>
<h3 id="running-all-integration-tests"><a class="header" href="#running-all-integration-tests">Running All Integration Tests</a></h3>
<pre><code class="language-bash"># Run all integration tests
cargo test --test integration_tests \
           --test event_processing_tests \
           --test action_tests \
           --test action_orchestration_tests

# Run all tests with coverage
cargo test --all-features
</code></pre>
<h3 id="writing-new-integration-tests"><a class="header" href="#writing-new-integration-tests">Writing New Integration Tests</a></h3>
<p>When adding new integration tests:</p>
<ol>
<li><strong>Use the MIDI simulator</strong> for all MIDI event generation</li>
<li><strong>Test edge cases</strong> (boundary values, timing variations)</li>
<li><strong>Include negative tests</strong> (error conditions, invalid inputs)</li>
<li><strong>Verify timing</strong> with tolerance (±10-35ms for CI stability)</li>
<li><strong>Document test purpose</strong> with clear comments</li>
<li><strong>Group related tests</strong> into logical test modules</li>
</ol>
<p>Example template:</p>
<pre><code class="language-rust">#[test]
fn test_feature_name() {
    let sim = MidiSimulator::new(0);

    // Setup: Generate test events
    sim.note_on(60, 80);

    // Execute: Perform action
    let events = sim.get_events();

    // Verify: Check results
    assert_eq!(events.len(), 1);
    assert_eq!(events[0][0] &amp; 0xF0, 0x90); // Note On
}</code></pre>
<h3 id="cicd-integration"><a class="header" href="#cicd-integration">CI/CD Integration</a></h3>
<p>All integration tests run automatically in GitHub Actions:</p>
<ul>
<li><strong>No hardware required</strong>: Uses MIDI simulator</li>
<li><strong>Fast execution</strong>: &lt;5 seconds total for all tests</li>
<li><strong>Timing tolerance</strong>: Increased for CI environments (±35ms)</li>
<li><strong>Platform coverage</strong>: Tests run on macOS, Linux, Windows</li>
</ul>
<h2 id="related-documentation"><a class="header" href="#related-documentation">Related Documentation</a></h2>
<ul>
<li><a href="../architecture/event-processing.html">Event Processing Architecture</a></li>
<li><a href="../reference/midi-events.html">MIDI Event Types</a></li>
<li><a href="../reference/actions.html">Action System</a></li>
<li><a href="../contributing.html">Contributing Guide</a></li>
</ul>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>See the integration tests in <code>tests/integration_tests.rs</code> for complete examples of:</p>
<ul>
<li>Velocity detection tests</li>
<li>Long press simulation</li>
<li>Double-tap detection</li>
<li>Chord detection</li>
<li>Encoder simulation</li>
<li>Complex multi-event scenarios</li>
</ul>
<p>Additional examples in specialized test suites:</p>
<ul>
<li><code>tests/event_processing_tests.rs</code>: Aftertouch and pitch bend</li>
<li><code>tests/action_tests.rs</code>: Application launch and volume control</li>
<li><code>tests/action_orchestration_tests.rs</code>: Action sequences and conditionals</li>
</ul>
<h2 id="support"><a class="header" href="#support">Support</a></h2>
<p>For questions or issues with testing:</p>
<ul>
<li>Check existing integration tests for examples</li>
<li>Use the interactive CLI tool to experiment</li>
<li>Review the simulator source code in <code>tests/midi_simulator.rs</code></li>
<li>Open an issue on GitHub with test failure details</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../development/contributing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../development/release-process.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../development/contributing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../development/release-process.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
